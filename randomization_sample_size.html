<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RCT Randomization Simulator: 2-Step</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
        }

        header { text-align: center; margin-bottom: 20px; }
        h1 { font-weight: 700; margin: 0 0 10px 0; font-size: 28px; color: #2c3e50; }
        .citation { font-size: 16px; color: #666; font-style: italic; }

        .main-container {
            background: #ffffff;
            border: 1px solid #e1e4e8;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            width: 90%;
            max-width: 1000px;
            padding: 30px;
            min-height: 600px;
            position: relative;
        }

        .slide { display: none; animation: fadeIn 0.4s ease-in; }
        .slide.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        button {
            padding: 12px 24px;
            font-size: 15px;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-small { background-color: #e74c3c; color: white; }
        .btn-small:hover { background-color: #c0392b; }
        .btn-large { background-color: #27ae60; color: white; }
        .btn-large:hover { background-color: #219150; }

        .feedback-bar {
            text-align: center;
            font-size: 16px;
            padding: 20px;
            background: #fafafa;
            border-radius: 4px;
            border-left: 5px solid #ccc;
            margin-bottom: 20px;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .result-header { font-weight: bold; font-size: 18px; margin-bottom: 5px; }
        .result-counts { font-family: monospace; font-size: 14px; color: #555; line-height: 1.5; }

        .content-area {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-top: 10px;
        }

        .chart-wrapper {
            flex: 2;
            min-width: 300px;
        }
        .chart-area {
            height: 360px;
            position: relative;
        }
        .diff-line {
            margin-top: 10px;
            text-align: center;
            font-family: monospace;
            font-size: 14px;
            color: #555;
            background: #fff;
            border: 1px dashed #ddd;
            border-radius: 6px;
            padding: 8px 10px;
        }

        .lesson-box {
            flex: 1;
            min-width: 250px;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
        }
        .lesson-box h3 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 2px solid #e74c3c;
            padding-bottom: 10px;
            font-size: 18px;
        }
        .lesson-box p { font-size: 14px; line-height: 1.6; color: #555; }
        .highlight { font-weight: bold; color: #333; }

        .confounder-list {
            list-style: none; padding: 0; margin: 0;
            display: grid; grid-template-columns: 1fr; gap: 12px;
            max-width: 800px; margin: 0 auto;
        }
        .factor-item {
            padding: 15px;
            background: white;
            border: 1px solid #eee;
            border-radius: 6px;
            display: flex; justify-content: space-between; align-items: center;
            font-size: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .factor-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .delta {
            font-family: monospace;
            font-size: 13px;
            color: #777;
            white-space: nowrap;
        }
        .badge {
            font-size: 13px; font-weight: bold; padding: 4px 10px;
            border-radius: 12px; text-transform: uppercase;
            white-space: nowrap;
        }
        .badge-bad { background-color: #fce8e6; color: #c0392b; }
        .badge-good { background-color: #e8f5e9; color: #27ae60; }

        .nav-area {
            margin-top: 20px; text-align: right;
            border-top: 1px solid #eee; padding-top: 20px;
        }
        .btn-nav {
            background-color: #34495e; color: white;
            display: inline-flex; align-items: center; gap: 8px;
        }
        .btn-nav:disabled { background-color: #95a5a6; cursor: not-allowed; }
        .btn-nav:hover:not(:disabled) { background-color: #2c3e50; }

    </style>
</head>
<body>

    <header>
        <h1>RCT Randomization Simulator</h1>
        <div class="citation">Based on Bergenholtz 2026a</div>
    </header>

    <div class="main-container">

        <div id="slide1" class="slide active">
            <div class="controls">
                <button class="btn-small" onclick="runSimulation1(10)">
                    Simulate Small Group (N=10)
                </button>
                <button class="btn-large" onclick="runSimulation1(150)">
                    Simulate Large Group (N=150)
                </button>
            </div>

            <div id="feedback1" class="feedback-bar">
                Select a sample size above to begin.
            </div>

            <div class="content-area">
                <div class="chart-wrapper">
                    <div class="chart-area">
                        <canvas id="genderChart"></canvas>
                    </div>
                    <div id="diffLine" class="diff-line">
                        Difference (Treatment − Control): —
                    </div>
                </div>

                <div class="lesson-box">
                    <h3>Pedagogical Lesson</h3>
                    <p>
                        <strong>In an RCT, we care about whether the randomized <em>treatment</em> and <em>control</em> groups look similar at baseline.</strong>
                    </p>
                    <p>
                        In small samples (<span class="highlight">N=10</span>), random assignment can still produce large differences between groups by chance.
                    </p>
                    <p>
                        In larger samples (<span class="highlight">N=150</span>), big chance imbalances become less likely, so groups are typically more comparable.
                    </p>
                    <p style="font-size: 12px; color: #888; margin-top: 20px;">
                        <em>Try clicking the buttons multiple times to see how the Treatment vs Control gap changes.</em>
                    </p>
                </div>
            </div>

            <div class="nav-area">
                <button id="btnNext" class="btn-nav" onclick="goToSlide2()" disabled>
                    Next: Check Hidden Factors &rarr;
                </button>
            </div>
        </div>

        <div id="slide2" class="slide">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2 style="color: #2c3e50; margin: 0;">Step 2: The Hidden Factors</h2>
                <p style="color: #666;">Gender might look balanced… but what about baseline factors you didn’t measure?</p>
            </div>

            <div id="feedback2" class="feedback-bar"></div>

            <ul class="confounder-list" id="factorList"></ul>

            <div class="nav-area" style="text-align: left; display:flex; justify-content:space-between;">
                <button class="btn-nav" onclick="goToSlide1()">
                    &larr; Back to Start
                </button>
                <span style="align-self:center; color:#888; font-size:14px;">Simulated with <span id="n-display" style="font-weight:bold">N=...</span></span>
            </div>
        </div>

    </div>

    <script>
        // --- GLOBAL STATE ---
        let currentN = 0;
        let hasRun = false;

        // Stores the most recent run so Step 2 reveals the SAME underlying participants
        // (instead of re-randomizing when you click Next).
        let lastRun = null;

        // Hidden factors are generated in Step 1 but only shown in Step 2.
        // p = base rate (arbitrary but plausible-looking for teaching).
        const hiddenFactors = [
            { key: "age_old",      name: "Age Distribution (Older vs Younger)",       p: 0.40 },
            { key: "smoker",       name: "Smoking Status (Smoker vs Non)",            p: 0.25 },
            { key: "gen_high",     name: "Genetics (High Risk vs Low)",               p: 0.30 },
            { key: "severity_hi",  name: "Disease Severity (High vs Low)",            p: 0.20 },
            { key: "comorb",       name: "Comorbidities (Diabetes, etc.)",            p: 0.35 }
        ];

        // Simple imbalance rule for Step 2:
        // label "Imbalanced" if absolute difference in rates is >= 15 percentage points.
        // With small N this happens often; with large N it is much rarer.
        const IMBALANCE_THRESHOLD = 0.15; // 15pp

        // --- HELPERS ---
        function shuffleInPlace(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function pct(count, denom) {
            return (denom === 0) ? 0 : (count / denom) * 100;
        }

        function formatPct(x) {
            // one decimal, but drop trailing .0
            const s = (Math.round(x * 10) / 10).toFixed(1);
            return s.endsWith(".0") ? s.slice(0, -2) : s;
        }

        function formatPP(x) {
            // x in percentage points already (e.g., 12.3 means 12.3pp)
            let v = Math.round(x * 10) / 10;
            if (Object.is(v, -0)) v = 0;
            const s = v.toFixed(1);
            const clean = s.endsWith(".0") ? s.slice(0, -2) : s;
            const sign = (v > 0) ? "+" : "";
            return `${sign}${clean}pp`;
        }

        // --- CHART SETUP (TWO DATASETS = TWO COLORS) ---
        const ctx = document.getElementById('genderChart').getContext('2d');
        const myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Male', 'Female', 'Other'],
                datasets: [
                    {
                        label: 'Treatment',
                        data: [0, 0, 0],
                        backgroundColor: 'rgba(54, 162, 235, 0.70)',
                        borderWidth: 1
                    },
                    {
                        label: 'Control',
                        data: [0, 0, 0],
                        backgroundColor: 'rgba(255, 99, 132, 0.70)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, title: { display: true, text: 'Count' } }
                },
                plugins: {
                    legend: { display: true, position: 'top' }
                },
                animation: { duration: 500 }
            }
        });

        // --- SLIDE 1 LOGIC: GENERATE PARTICIPANTS, RANDOMIZE INTO 2 ARMS, SHOW BASELINE BALANCE ---
        function runSimulation1(n) {
            currentN = n;
            hasRun = true;

            // 1) Generate participants (gender + hidden factors)
            const participants = [];
            for (let i = 0; i < n; i++) {
                // Gender draw: Male 0.48, Female 0.48, Other 0.04
                const r = Math.random();
                let gender = "O";
                if (r < 0.48) gender = "M";
                else if (r < 0.96) gender = "F";

                const hidden = {};
                hiddenFactors.forEach(f => {
                    hidden[f.key] = (Math.random() < f.p);
                });

                participants.push({ gender, hidden, arm: null });
            }

            // 2) Random assignment into Treatment vs Control (balanced sizes by shuffling + splitting)
            shuffleInPlace(participants);
            const nT = Math.floor(n / 2);
            const nC = n - nT;

            participants.forEach((p, idx) => {
                p.arm = (idx < nT) ? "T" : "C";
            });

            // 3) Count gender by arm
            const t = { M: 0, F: 0, O: 0 };
            const c = { M: 0, F: 0, O: 0 };

            participants.forEach(p => {
                if (p.arm === "T") t[p.gender]++;
                else c[p.gender]++;
            });

            // 4) Update chart (two bars per category)
            myChart.data.datasets[0].data = [t.M, t.F, t.O]; // Treatment
            myChart.data.datasets[1].data = [c.M, c.F, c.O]; // Control
            myChart.update();

            // 5) Compute percentages within each arm and differences (Treatment - Control) in percentage points
            const tMale = pct(t.M, nT), tFemale = pct(t.F, nT), tOther = pct(t.O, nT);
            const cMale = pct(c.M, nC), cFemale = pct(c.F, nC), cOther = pct(c.O, nC);

            const dMale = tMale - cMale;
            const dFemale = tFemale - cFemale;
            const dOther = tOther - cOther;

            // 6) Update the “difference line” under the chart
            document.getElementById('diffLine').innerText =
                `Difference (Treatment − Control): Male ${formatPP(dMale)} | Female ${formatPP(dFemale)} | Other ${formatPP(dOther)}`;

            // 7) Feedback box
            const feedbackBox = document.getElementById('feedback1');

            let message = "";
            let color = "";
            if (n === 10) {
                message = "Small N: large baseline differences between Treatment and Control can occur by chance.";
                color = "#e74c3c";
            } else {
                message = "Large N: big chance imbalances are less likely; groups are usually more comparable.";
                color = "#27ae60";
            }

            feedbackBox.innerHTML = `
                <span class="result-header">Result (N=${n})</span>
                <span class="result-counts">
                    Treatment (n=${nT}): M ${t.M} (${formatPct(tMale)}%), F ${t.F} (${formatPct(tFemale)}%), O ${t.O} (${formatPct(tOther)}%)<br>
                    Control&nbsp;&nbsp;(n=${nC}): M ${c.M} (${formatPct(cMale)}%), F ${c.F} (${formatPct(cFemale)}%), O ${c.O} (${formatPct(cOther)}%)
                </span>
                <div style="margin-top:8px; font-size:14px;">${message}</div>
            `;
            feedbackBox.style.borderLeftColor = color;

            // 8) Store run for Step 2 reveal
            lastRun = { n, nT, nC, participants };

            // Enable Step 2
            document.getElementById('btnNext').disabled = false;
        }

        // --- SLIDE NAVIGATION ---
        function goToSlide2() {
            if (!hasRun || !lastRun) return;

            document.getElementById('slide1').classList.remove('active');
            document.getElementById('slide2').classList.add('active');

            document.getElementById('n-display').innerText = `N=${currentN}`;
            runHiddenFactorCheck();
        }

        function goToSlide1() {
            document.getElementById('slide2').classList.remove('active');
            document.getElementById('slide1').classList.add('active');
        }

        // --- SLIDE 2 LOGIC (REVEAL HIDDEN FACTORS FROM THE SAME RUN) ---
        function runHiddenFactorCheck() {
            if (!lastRun) return;

            const { nT, nC, participants } = lastRun;

            const list = document.getElementById('factorList');
            list.innerHTML = "";

            let badCount = 0;

            hiddenFactors.forEach(f => {
                let tCount = 0, cCount = 0;

                participants.forEach(p => {
                    if (!p.hidden[f.key]) return;
                    if (p.arm === "T") tCount++;
                    else cCount++;
                });

                const tRate = (nT === 0) ? 0 : tCount / nT;
                const cRate = (nC === 0) ? 0 : cCount / nC;
                const diff = tRate - cRate;

                const isImbalanced = Math.abs(diff) >= IMBALANCE_THRESHOLD;
                if (isImbalanced) badCount++;

                const li = document.createElement('li');
                li.className = "factor-item";
                li.innerHTML = `
                    <strong>${f.name}</strong>
                    <div class="factor-right">
                        <span class="delta">Δ(T−C): ${formatPP(diff * 100)}</span>
                        <span class="badge ${isImbalanced ? 'badge-bad' : 'badge-good'}">
                            ${isImbalanced ? '⚠️ Imbalanced' : '✓ Balanced'}
                        </span>
                    </div>
                `;
                list.appendChild(li);
            });

            const fb = document.getElementById('feedback2');
            if (badCount > 0) {
                fb.innerHTML = `
                    <div style="color:#c0392b; font-weight:bold; font-size:18px;">Warning: ${badCount} Hidden Imbalances</div>
                    <div style="margin-top:6px;">
                        Even if Gender looks okay, unmeasured baseline factors can still differ between Treatment and Control by chance.
                    </div>
                    <div style="font-weight:600; margin-top:6px;">
                        Larger N makes big imbalances less likely across many possible confounders.
                    </div>
                `;
                fb.style.borderLeftColor = "#e74c3c";
            } else {
                fb.innerHTML = `
                    <div style="color:#27ae60; font-weight:bold; font-size:18px;">All Hidden Factors Balanced</div>
                    <div style="margin-top:6px;">
                        In this run, Treatment and Control ended up similar on these unmeasured factors.
                    </div>
                    <div style="margin-top:6px;">
                        (This is more common when N is large — but not guaranteed.)
                    </div>
                `;
                fb.style.borderLeftColor = "#27ae60";
            }
        }
    </script>
</body>
</html>
